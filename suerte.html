<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
  import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyA2qF7V3izwM6W20U50_bgpXp89ATBR1ug",
    authDomain: "codigos-5820e.firebaseapp.com",
    projectId: "codigos-5820e",
    storageBucket: "codigos-5820e.appspot.com",
    messagingSenderId: "231416234142",
    appId: "1:231416234142:web:fa59eaddaee1c0bd58fb8f"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  async function validarCodi() {
    const codi = document.getElementById("codeInput").value.trim();

    if (!codi) {
      alert("⚠️ Ingresa un código válido.");
      return;
    }

    try {
      const docRef = doc(db, "codigos_validos", codi);
      const docSnap = await getDoc(docRef);

      if (docSnap.exists()) {
        const datos = docSnap.data();
        if (datos.valido === true && datos.usado === false) {
          await updateDoc(docRef, { usado: true });
          document.getElementById("codeSection").classList.add("hidden");
          document.getElementById("ruletaSection").classList.remove("hidden");
        } else {
          alert("❌ Código inválido o ya utilizado.");
        }
      } else {
        alert("❌ Código no encontrado.");
      }
    } catch (error) {
      console.error("Error al validar el código:", error);
      alert("⚠️ Hubo un problema al validar el código. Inténtalo de nuevo.");
    }
  }

  window.validarCodi = validarCodi;
</script>
