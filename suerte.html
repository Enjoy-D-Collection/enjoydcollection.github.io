<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ruleta Promocional</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

    // üîπ Configuraci√≥n de Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyA2qF7V3izwM6W20U50_bgpXp89ATBR1ug",
      authDomain: "codigos-5820e.firebaseapp.com",
      projectId: "codigos-5820e",
      storageBucket: "codigos-5820e.appspot.com",
      messagingSenderId: "231416234142",
      appId: "1:231416234142:web:fa59eaddaee1c0bd58fb8f"
    };

    // üîπ Inicializar Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // üîπ Funci√≥n para validar c√≥digo desde Firebase
   async function validarCodi() {
    const codi = document.getElementById("codeInput").value.trim();
    
    console.log("C√≥digo ingresado:", codi);  // üîπ Verifica qu√© c√≥digo se est√° enviando
    
    if (!codi) {
        alert("‚ö†Ô∏è Ingresa un c√≥digo v√°lido.");
        return;
    }

    const docRef = doc(db, "codigos_validos", codi);
    console.log("Referencia del documento:", docRef);  // üîπ Verifica si Firebase est√° generando la referencia correctamente

    const docSnap = await getDoc(docRef);

    if (docSnap.exists()) {
        console.log("Documento encontrado en Firebase:", docSnap.data());  // üîπ Verifica qu√© datos est√° obteniendo de Firebase

        const datos = docSnap.data();
        if (datos.valido === true && datos.usado === false) {
            await updateDoc(docRef, { usado: true });
            document.getElementById("codeSection").classList.add("hidden");
            document.getElementById("ruletaSection").classList.remove("hidden");
        } else {
            alert("‚ùå C√≥digo inv√°lido o ya utilizado.");
        }
    } else {
        console.log("‚ùå C√≥digo no encontrado en Firebase.");
        alert("‚ùå C√≥digo no encontrado.");
    }
}
    window.validarCodi = validarCodi; // Permitir acceso desde HTML
  </script>
  <style>
    body { font-family: sans-serif; text-align: center; padding: 2rem; }
    canvas { margin-top: 2rem; }
    .hidden { display: none; }
    #result { margin-top: 1.5rem; font-size: 1.5rem; font-weight: bold; }
    #codeSection { margin-bottom: 1.5rem; }
  </style>
</head>
<body>
  <h1>Promoci√≥ Especial - Prova Sort!</h1>

  <div id="codeSection">
    <p>Introdueix el teu codi exclusiu per accedir a la ruleta:</p>
    <input type="text" id="codeInput" placeholder="Codi de comprador" />
    <button onclick="validarCodi()">Validar</button>
  </div>

  <div id="ruletaSection" class="hidden">
    <canvas id="wheelCanvas" width="300" height="300"></canvas>
    <br />
    <button onclick="girarRuleta()">Girar ruleta</button>
    <div id="result"></div>
  </div>

  <script>
    let canvas, ctx, sectors, currentAngle = 0;

    window.onload = function () {
      canvas = document.getElementById("wheelCanvas");
      ctx = canvas.getContext("2d");
      sectors = ["üéâ Premi!", "No premi", "No premi", "No premi", "No premi",
                 "No premi", "No premi", "No premi", "No premi", "No premi",
                 "No premi", "No premi", "No premi", "No premi", "No premi",
                 "No premi", "No premi", "No premi", "No premi", "No premi"];
      drawWheel(currentAngle);
    };

    function drawWheel(angle) {
      const numSectors = sectors.length;
      const arc = 2 * Math.PI / numSectors;
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      for (let i = 0; i < numSectors; i++) {
        const start = angle + i * arc;
        ctx.beginPath();
        ctx.moveTo(150, 150);
        ctx.arc(150, 150, 150, start, start + arc);
        ctx.fillStyle = i % 2 === 0 ? "#fcd34d" : "#fbbf24";
        ctx.fill();
        ctx.save();
        ctx.translate(150, 150);
        ctx.rotate(start + arc / 2);
        ctx.textAlign = "right";
        ctx.fillStyle = "#000";
        ctx.font = "14px sans-serif";
        ctx.fillText(sectors[i], 140, 5);
        ctx.restore();
      }
    }

    function girarRuleta() {
      const giro = Math.floor(Math.random() * 360) + 720;
      const duration = 3000;
      const start = Date.now();
      const animate = () => {
        const elapsed = Date.now() - start;
        const progress = elapsed / duration;
        if (progress < 1) {
          currentAngle += (giro / duration) * 20;
          drawWheel(currentAngle * Math.PI / 180);
          requestAnimationFrame(animate);
        } else {
          currentAngle += giro;
          currentAngle %= 360;
          drawWheel(currentAngle * Math.PI / 180);
          const selected = Math.floor((sectors.length - (currentAngle / (360 / sectors.length))) % sectors.length);
          const result = sectors[selected];
          document.getElementById("result").textContent =
            result === "üéâ Premi!" ? "üéâ Enhorabona! Has guanyat un sobre!" : "Ho sentim, aquesta vegada no t'ha tocat.";
        }
      };
      animate();
    }
  </script>
</body>
</html>
